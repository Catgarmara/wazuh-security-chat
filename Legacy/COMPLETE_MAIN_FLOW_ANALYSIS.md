# ğŸ”„ **Complete Execution Flow Chart: `/main.py` â†’ Full Application Startup**

## **ğŸš€ Entry Point Flow with Decision Logic**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         START: python main.py                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 1: IMPORTS                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   uvicorn       â”‚  â”‚   argparse      â”‚  â”‚   sys/pathlib   â”‚ â”‚
â”‚  â”‚ (web server)    â”‚  â”‚ (CLI parsing)   â”‚  â”‚ (path setup)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        Add project root to Python path                     â”‚ â”‚
â”‚  â”‚        sys.path.insert(0, str(project_root))               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ core.config     â”‚  â”‚         app.main                        â”‚ â”‚
â”‚  â”‚ get_settings()  â”‚  â”‚         FastAPI app                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 2: CLI PARSING                         â”‚
â”‚                                                                 â”‚
â”‚  parser.add_argument("--host")     â†â”€â”€ CLI Option: Host IP     â”‚
â”‚  parser.add_argument("--port")     â†â”€â”€ CLI Option: Port        â”‚
â”‚  parser.add_argument("--reload")   â†â”€â”€ CLI Option: Dev Mode    â”‚
â”‚  parser.add_argument("--workers")  â†â”€â”€ CLI Option: Processes   â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â–¼                                      â”‚
â”‚                   args = parser.parse_args()                   â”‚
â”‚                   settings = get_settings()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PHASE 3: DECISION LOGIC                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                HOST RESOLUTION                              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  if args.host:          â†â”€â”€ Command line provided?         â”‚ â”‚
â”‚  â”‚      host = args.host   â†â”€â”€ YES: Use CLI argument          â”‚ â”‚
â”‚  â”‚  else:                  â†â”€â”€ NO: Fall back to config        â”‚ â”‚
â”‚  â”‚      host = settings.host  â†â”€â”€ Use settings.host          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                PORT RESOLUTION                              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  if args.port:          â†â”€â”€ Command line provided?         â”‚ â”‚
â”‚  â”‚      port = args.port   â†â”€â”€ YES: Use CLI argument          â”‚ â”‚
â”‚  â”‚  else:                  â†â”€â”€ NO: Fall back to config        â”‚ â”‚
â”‚  â”‚      port = settings.port  â†â”€â”€ Use settings.port          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PHASE 4: STARTUP INFO                         â”‚
â”‚                                                                 â”‚
â”‚  print(f"ğŸš€ Starting {settings.app_name} v{settings.version}") â”‚
â”‚  print(f"ğŸŒ Server: http://{host}:{port}")                     â”‚
â”‚  print(f"ğŸ”§ Environment: {settings.environment}")              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PHASE 5: WORKERS DECISION LOGIC                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  if args.reload:               â†â”€â”€ Development mode?        â”‚ â”‚
â”‚  â”‚      workers = 1               â†â”€â”€ YES: Force single worker â”‚ â”‚
â”‚  â”‚  else:                         â†â”€â”€ NO: Production mode     â”‚ â”‚
â”‚  â”‚      workers = args.workers    â†â”€â”€ Use specified workers   â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PHASE 6: UVICORN SERVER LAUNCH                   â”‚
â”‚                                                                 â”‚
â”‚  uvicorn.run(                                                   â”‚
â”‚      "app.main:app",           â†â”€â”€ Points to FastAPI app       â”‚
â”‚      host=host,                â†â”€â”€ Resolved host               â”‚
â”‚      port=port,                â†â”€â”€ Resolved port               â”‚
â”‚      reload=args.reload,       â†â”€â”€ Development auto-reload     â”‚
â”‚      workers=workers,          â†â”€â”€ Worker processes            â”‚
â”‚      log_level=settings.log_level.lower()                      â”‚
â”‚  )                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            UVICORN LOADS: "app.main:app"                        â”‚
â”‚                   â†“                                             â”‚
â”‚            ENTERS: app/main.py                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
```

---

## **ğŸ—ï¸ FastAPI Application Creation Flow (`app/main.py`)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FASTAPI STARTUP SEQUENCE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PHASE 7: LIFESPAN MANAGER                      â”‚
â”‚                                                                 â”‚
â”‚  @asynccontextmanager                                           â”‚
â”‚  async def lifespan(app: FastAPI):                              â”‚
â”‚      # STARTUP SEQUENCE                                         â”‚
â”‚      settings = get_settings()        â†â”€â”€ Load configuration   â”‚
â”‚      container = get_container()       â†â”€â”€ Dependency injection â”‚
â”‚      init_database()                  â†â”€â”€ Database setup       â”‚
â”‚      metrics.set_app_info()           â†â”€â”€ Metrics setup        â”‚
â”‚                                                                 â”‚
â”‚      yield  â†â”€â”€ APP RUNS HERE                                  â”‚
â”‚                                                                 â”‚
â”‚      # SHUTDOWN SEQUENCE                                        â”‚
â”‚      shutdown_database()              â†â”€â”€ Clean database       â”‚
â”‚      container.clear_scoped()         â†â”€â”€ Clean DI container   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PHASE 8: FASTAPI APP CREATION                    â”‚
â”‚                                                                 â”‚
â”‚  app = FastAPI(                                                 â”‚
â”‚      title=settings.app_name,         â†â”€â”€ "Wazuh AI Companion" â”‚
â”‚      version=settings.version,        â†â”€â”€ "2.0.0"              â”‚
â”‚      debug=settings.debug,            â†â”€â”€ True/False           â”‚
â”‚      lifespan=lifespan                â†â”€â”€ Startup/shutdown     â”‚
â”‚  )                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PHASE 9: MIDDLEWARE SETUP                       â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                CORS Middleware                              â”‚ â”‚
â”‚  â”‚  allow_origins=settings.cors_origins                       â”‚ â”‚
â”‚  â”‚  allow_credentials=True                                     â”‚ â”‚
â”‚  â”‚  allow_methods=["*"]                                        â”‚ â”‚
â”‚  â”‚  allow_headers=["*"]                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Audit Logging Middleware                       â”‚ â”‚
â”‚  â”‚  setup_audit_middleware(app)                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               Security Middleware                           â”‚ â”‚
â”‚  â”‚  setup_middleware(app)                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               Metrics Middleware                            â”‚ â”‚
â”‚  â”‚  setup_metrics_middleware(app)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PHASE 10: ROUTE REGISTRATION                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/v1/auth   â”‚  â”‚  /api/v1/chat   â”‚  â”‚  /api/v1/logs   â”‚ â”‚
â”‚  â”‚  (auth_router)  â”‚  â”‚  (chat_router)  â”‚  â”‚  (logs_router)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/v1/audit   â”‚  â”‚/api/v1/analyticsâ”‚  â”‚  /api/v1/ai     â”‚ â”‚
â”‚  â”‚ (audit_router)  â”‚  â”‚(analytics_routerâ”‚  â”‚  (ai_router)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/v1/siem   â”‚  â”‚  /api/v1/alerts â”‚  â”‚  /api/v1/threat â”‚ â”‚
â”‚  â”‚  (siem_router)  â”‚  â”‚  (alert_mgmt)   â”‚  â”‚ (threat_correl) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚     /ws/        â”‚  â”‚   /ws/siem      â”‚                     â”‚
â”‚  â”‚ (websocket)     â”‚  â”‚ (siem_websocket)â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PHASE 11: HEALTH CHECK ENDPOINTS                   â”‚
â”‚                                                                 â”‚
â”‚  @app.get("/health")                    â†â”€â”€ Basic health       â”‚
â”‚  @app.get("/health/detailed")           â†â”€â”€ Full system status â”‚
â”‚  @app.get("/health/{service_name}")     â†â”€â”€ Individual service â”‚
â”‚  @app.get("/metrics")                   â†â”€â”€ Prometheus metrics â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PHASE 12: APP INSTANCE                          â”‚
â”‚                                                                 â”‚
â”‚                  app = create_app()                             â”‚
â”‚                         â”‚                                       â”‚
â”‚                    âœ… READY TO SERVE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SERVER RUNNING                                â”‚
â”‚                                                                 â”‚
â”‚  ğŸŒ Listening on http://host:port                              â”‚
â”‚  ğŸ“¡ WebSocket connections ready                                 â”‚
â”‚  ğŸ—„ï¸ Database connected                                         â”‚
â”‚  ğŸ§  AI services initialized                                     â”‚
â”‚  ğŸ“Š Metrics collection active                                   â”‚
â”‚  ğŸ” Authentication ready                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **ğŸ¯ Key Decision Points Summary:**

| **Decision Point** | **Logic** | **File Location** |
|-------------------|-----------|------------------|
| **Host Selection** | `args.host or settings.host` | `/main.py:47` |
| **Port Selection** | `args.port or settings.port` | `/main.py:48` |
| **Worker Count** | `args.workers if not args.reload else 1` | `/main.py:59` |
| **Settings Creation** | `try: AppSettings() except: test_defaults` | `core/config.py:210-217` |
| **Environment Mode** | `settings.environment` (dev/staging/prod) | `core/config.py:170` |
| **Debug Mode** | `settings.debug` (True/False) | `core/config.py:171` |

---

## **ğŸ”„ Complete Function Call Chain:**

```
python main.py
â”œâ”€â”€ main() 
â”‚   â”œâ”€â”€ argparse.ArgumentParser()
â”‚   â”œâ”€â”€ get_settings() â†’ core/config.py:207
â”‚   â”‚   â”œâ”€â”€ AppSettings() â†’ core/config.py:165
â”‚   â”‚   â”‚   â”œâ”€â”€ DatabaseSettings()
â”‚   â”‚   â”‚   â”œâ”€â”€ RedisSettings() 
â”‚   â”‚   â”‚   â”œâ”€â”€ SecuritySettings()
â”‚   â”‚   â”‚   â”œâ”€â”€ AISettings()
â”‚   â”‚   â”‚   â””â”€â”€ LogSettings()
â”‚   â”‚   â””â”€â”€ Field validations (port ranges, secret key length, etc.)
â”‚   â””â”€â”€ uvicorn.run("app.main:app")
â”‚       â””â”€â”€ app/main.py
â”‚           â”œâ”€â”€ lifespan() async context manager
â”‚           â”‚   â”œâ”€â”€ get_settings()
â”‚           â”‚   â”œâ”€â”€ get_container() â†’ core/container.py:190
â”‚           â”‚   â”œâ”€â”€ init_database() â†’ core/database.py
â”‚           â”‚   â””â”€â”€ metrics.set_app_info()
â”‚           â”œâ”€â”€ create_app()
â”‚           â”‚   â”œâ”€â”€ FastAPI() initialization
â”‚           â”‚   â”œâ”€â”€ CORSMiddleware setup
â”‚           â”‚   â”œâ”€â”€ setup_audit_middleware()
â”‚           â”‚   â”œâ”€â”€ setup_middleware()
â”‚           â”‚   â”œâ”€â”€ setup_metrics_middleware()
â”‚           â”‚   â”œâ”€â”€ 11 router inclusions (auth, chat, logs, etc.)
â”‚           â”‚   â””â”€â”€ Health check endpoints
â”‚           â””â”€â”€ Return configured FastAPI app instance
```

---

## **ğŸ“Š Configuration Loading Sequence:**

### **Core Settings Hierarchy (core/config.py)**

```
AppSettings
â”œâ”€â”€ app_name: "Wazuh AI Companion"
â”œâ”€â”€ version: "2.0.0"
â”œâ”€â”€ environment: DEVELOPMENT|STAGING|PRODUCTION
â”œâ”€â”€ debug: True|False
â”œâ”€â”€ host: "0.0.0.0"
â”œâ”€â”€ port: 8000
â”œâ”€â”€ log_level: DEBUG|INFO|WARNING|ERROR|CRITICAL
â”œâ”€â”€ cors_origins: ["*"] or comma-separated list
â”œâ”€â”€ api_prefix: "/api/v1"
â”‚
â”œâ”€â”€ DatabaseSettings
â”‚   â”œâ”€â”€ host: "localhost"
â”‚   â”œâ”€â”€ port: 5432
â”‚   â”œâ”€â”€ name: "wazuh_chat"
â”‚   â”œâ”€â”€ user: "postgres"
â”‚   â”œâ”€â”€ password: ""
â”‚   â”œâ”€â”€ pool_size: 10
â”‚   â””â”€â”€ max_overflow: 20
â”‚
â”œâ”€â”€ RedisSettings
â”‚   â”œâ”€â”€ host: "localhost"
â”‚   â”œâ”€â”€ port: 6379
â”‚   â”œâ”€â”€ db: 0
â”‚   â”œâ”€â”€ password: None
â”‚   â””â”€â”€ max_connections: 20
â”‚
â”œâ”€â”€ SecuritySettings
â”‚   â”œâ”€â”€ secret_key: (required, min 32 chars)
â”‚   â”œâ”€â”€ jwt_algorithm: "HS256"
â”‚   â”œâ”€â”€ access_token_expire_minutes: 30
â”‚   â”œâ”€â”€ refresh_token_expire_days: 7
â”‚   â”œâ”€â”€ password_min_length: 8
â”‚   â””â”€â”€ bcrypt_rounds: 12
â”‚
â”œâ”€â”€ AISettings
â”‚   â”œâ”€â”€ ollama_host: "localhost"
â”‚   â”œâ”€â”€ ollama_port: 11434
â”‚   â”œâ”€â”€ ollama_model: "llama3"
â”‚   â”œâ”€â”€ embedding_model: "all-MiniLM-L6-v2"
â”‚   â”œâ”€â”€ chunk_size: 500
â”‚   â”œâ”€â”€ chunk_overlap: 50
â”‚   â”œâ”€â”€ max_tokens: 2048
â”‚   â””â”€â”€ temperature: 0.7
â”‚
â””â”€â”€ LogSettings
    â”œâ”€â”€ wazuh_logs_path: "/var/ossec/logs/archives"
    â”œâ”€â”€ default_days_range: 7
    â”œâ”€â”€ max_days_range: 365
    â”œâ”€â”€ ssh_timeout: 10
    â””â”€â”€ log_batch_size: 1000
```

---

## **ğŸ›¡ï¸ Validation Rules Applied:**

### **Port Validations:**
- Database port: 1-65535
- Redis port: 1-65535
- Application port: 1-65535
- Ollama port: 1-65535

### **Security Validations:**
- Secret key: Minimum 32 characters
- Access token expiry: 1-1440 minutes (24 hours max)
- Bcrypt rounds: 4-20 (security vs. performance balance)
- Password minimum length: 8 characters

### **AI/ML Validations:**
- Chunk size: 100-2000 characters
- Temperature: 0.0-2.0 (creativity control)
- Redis DB: 0-15 (Redis supports 16 databases)

### **Log Processing Validations:**
- Default days range: 1-365 days
- Max days range: 1-365 days

---

## **ğŸ”§ Environment Variable Support:**

All settings can be overridden via environment variables:

```bash
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=wazuh_chat
DB_USER=postgres
DB_PASSWORD=secretpassword

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Security
SECRET_KEY=your-32-character-secret-key-here
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# AI/Ollama
OLLAMA_HOST=localhost
OLLAMA_PORT=11434
OLLAMA_MODEL=llama3
EMBEDDING_MODEL=all-MiniLM-L6-v2

# Application
APP_NAME="Wazuh AI Companion"
APP_VERSION=2.0.0
ENVIRONMENT=production
DEBUG=false
HOST=0.0.0.0
PORT=8000
LOG_LEVEL=INFO
CORS_ORIGINS=http://localhost:3000,https://yourdomain.com
```

---

## **âš¡ Command Line Examples:**

```bash
# Basic startup
python main.py

# Development mode with auto-reload
python main.py --reload

# Custom host and port
python main.py --host 127.0.0.1 --port 9000

# Production with multiple workers
python main.py --workers 4

# Full production setup
python main.py --host 0.0.0.0 --port 8080 --workers 8
```

---

## **ğŸ Startup Sequence Summary:**

The system follows a **12-phase startup sequence** with **6 key decision points** that determine host, port, workers, environment settings, and fallback configurations. Every decision has a clear if/else path with sensible defaults!

1. **Import Phase** - Load dependencies and set Python path
2. **CLI Parsing** - Process command line arguments
3. **Decision Logic** - Resolve host/port with CLI override capability
4. **Startup Info** - Display configuration details
5. **Workers Logic** - Determine worker count based on mode
6. **Server Launch** - Start uvicorn with resolved settings
7. **Lifespan Manager** - Handle startup/shutdown procedures
8. **FastAPI Creation** - Initialize web application framework
9. **Middleware Setup** - Configure security, CORS, audit, metrics
10. **Route Registration** - Register all API endpoints and WebSocket handlers
11. **Health Endpoints** - Set up monitoring and health check endpoints
12. **Ready to Serve** - Application fully initialized and ready for requests

**Key Features:**
- âœ… Graceful fallback for all configuration options
- âœ… Comprehensive validation with clear error messages  
- âœ… Environment variable support for all settings
- âœ… Development vs. production mode handling
- âœ… Proper async lifecycle management
- âœ… Full dependency injection container setup
- âœ… Security-first middleware configuration
- âœ… Health monitoring and metrics collection
- âœ… WebSocket support for real-time features